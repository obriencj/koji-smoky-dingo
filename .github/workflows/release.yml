# Github Action definition for publishing to PyPI when a release is
# tagged.


name: Release Assets


on:
  release:
    types: [published]


jobs:

  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install system packages
        run: |
          sudo apt-get install -y libssl-dev openssl swig

      - name: Install python dependencies
        run: |
          pip install wheel

      - name: Build source distribution
        run: |
          python setup.py sdist --output dist

      - name: Build binary wheel distribution
        run: |
          python setup.py bdist_wheel --output dist

      - name: Save python dist content
        uses: actions/upload-artifact@v3
        with:
          name: py-dist
          path: dist/

  rpms:
    name: Trigger RPM builds
    uses: ./.github/workflows/rpms.yml

  assets:
    name: Attach assets to release
    runs-on: ubuntu-latest

    needs:
      - build
      - rpms

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get install hub

      - name: Fetch python dist content
        uses: actions/download-artifact@v3
        with:
          name: py-dist

      - name: Fetch RPMs
        uses: actions/download-artifact@v3
        with:
          name: RPM

      - name: Upload python dist content
        run: |
          gh release upload ${{ github.ref_name }} \
            dist/*.whl \
            dist/*.src.rpm \
            dist/*/RPMS/noarch/*.rpm

  pypi:
    name: Upload release to PyPI
    runs-on: ubuntu-latest

    needs:
      - build

    environment:
      name: pypi
      url: https://pypi.org/p/kojismokydingo

    steps:
      - name: Fetch python dist content
        uses: actions/download-artifact@v3
        with:
          name: py-dist

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  announce:
    name: Announce release to @obriencj@fosstodon.org
    runs-on: ubuntu-latest

    needs:
      - artifacts
      - pypi

    steps:
      - name: Get current date
        id: date
        run: echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> "$GITHUB_ENV"

      - name: Create announcement post
        uses: rzr/fediverse-action@master
        with:
          host: fosstodon.org
          access-token: ${{ secrets.MASTODON_ACCESS_TOKEN }}

          message: |
            Version ${{ github.ref_name }} of koji-smoky-dingo was released on ${{ env.RELEASE_DATE }}
            https://github.com/obriencj/koji-smoky-dingo/releases/tag/${{ github.ref_name }}
            \#koji \#koji-smoky-dingo


# The end.
